<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
  <title>YouTube Jukebox Remote</title>
  <style>
    /* --- Base Styles --- */
    body {
      font-family: sans-serif;
      background: #f7f7f7;
      padding: 35px;
      margin: 0;
    }

    /* T·ªëi ∆∞u ho√° Playlist Item */
    .playlist-item {
      padding: 10px 15px; 
      margin-bottom: 12px;
      background: white;
      border-radius: 12px;
      font-size: 20px; 
      font-weight: 500;
      box-shadow: 0 1px 2px rgba(0,0,0,0.1);
      cursor: grab;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    /* Bu·ªôc ti√™u ƒë·ªÅ Playlist ch·ªâ 1 d√≤ng v√† c·∫Øt b·ªõt */
    .playlist-item span {
        font-size: 18px; 
        flex-grow: 1; 
        white-space: nowrap; 
        overflow: hidden; 
        text-overflow: ellipsis; 
        margin-right: 10px; 
    }

    /* TƒÉng v√πng b·∫•m n√∫t x√≥a (üóë) */
    .playlist-item button {
        padding: 8px 15px; 
        font-size: 16px;
        background: #e74c3c;
        margin-right: 0;
        flex-shrink: 0; 
        min-width: 40px; 
    }

    h1 {
      color: #cc0000;
      font-size: 26px;
      text-align: center;
      margin-bottom: 20px;
    }
    
    h2 {
        font-size: 20px;
        color: #333;
    }

    #searchInput, #playlistLinkInput { 
      width: 100%;
      padding: 24px; 
      font-size: 28px; 
      margin-bottom: 10px;
      box-sizing: border-box;
      border: 1px solid #ccc; 
    }
    
    #playlistLinkInput {
        font-size: 20px; 
        padding: 12px;
        margin-top: 10px;
        display: none; 
    }
    
    .search-box {
        display: flex;
        gap: 10px;
        margin-bottom: 10px;
    }
    
    /* Gi·∫£m k√≠ch th∆∞·ªõc n√∫t T√¨m ki·∫øm */
    .search-box button {
        flex-shrink: 0;
        width: 120px; 
        padding: 15px; 
        font-size: 18px; 
    }

    button {
      padding: 20px; 
      font-size: 20px;
      background: #cc0000;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      margin-right: 10px;
      transition: background 0.2s, transform 0.1s;
    }
    
    /* T·ªëi ∆∞u ho√° Connect Box */
    .connect-box {
        display: flex;
        gap: 10px; 
        align-items: center; 
        margin-bottom: 16px;
        flex-wrap: nowrap; 
        overflow-x: auto; 
    }

    .connect-box input {
        font-size: 20px; 
        padding: 12px; 
        flex: 1;
        min-width: 0; 
        box-sizing: border-box;
        margin-bottom: 0;
    }

    .connect-box button {
        font-size: 14px; 
        padding: 8px 12px; 
        width: auto;
        flex-shrink: 0; 
        margin-right: 0 !important;
    }
    
    .video-item {
      display: flex;
      align-items: flex-start;
      background: white;
      margin-bottom: 12px;
      border-radius: 10px;
      overflow: hidden;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .video-item img {
      width: 35%; 
      max-width: 150px;
      height: auto;
      object-fit: cover;
      flex-shrink: 0;
    }

    .video-info {
      padding: 10px;
      flex: 1;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
    }

    .video-title {
      font-size: 18px; 
      margin-bottom: 8px;
      font-weight: bold;
    }

    .action-buttons-row {
      display: flex;
      gap: 5px; 
      flex-wrap: nowrap; 
      margin-top: 5px;
      overflow-x: auto; 
    }

    .btn-action {
        flex-shrink: 0; 
        padding: 8px 10px !important; 
        font-size: 14px !important; 
        margin-right: 0 !important;
        white-space: nowrap;
    }
    
    .btn-priority {
        background: #f39c12 !important;
    }
    .btn-playnow {
        background: #007bff !important;
    }

    #loadMoreBtn {
        width: 100%;
        margin-top: 20px;
        background-color: #3498db;
    }
    
    .control-row {
        gap: 8px !important;
    }
    
    .control-row button {
        padding: 10px 12px !important;
        font-size: 16px !important;
        flex-grow: 1;
        min-width: 80px;
    }

    /* Gi·∫£m k√≠ch th∆∞·ªõc ch·ªØ c·ªßa label Karaoke/Playlist */
    .checkbox-label {
        font-size: 18px !important; 
    }

    /* Toast Message */
    #toast {
      visibility: hidden;
      min-width: 250px;
      background-color: #333;
      color: #fff;
      text-align: center;
      border-radius: 2px;
      padding: 16px;
      position: fixed;
      z-index: 1;
      left: 50%;
      bottom: 30px;
      transform: translateX(-50%);
      font-size: 17px;
    }

    #toast.show {
      visibility: visible;
      -webkit-animation: fadein 0.5s, fadeout 0.5s 1.5s;
      animation: fadein 0.5s, fadeout 0.5s 1.5s;
    }

    @-webkit-keyframes fadein {
      from {bottom: 0; opacity: 0;} 
      to {bottom: 30px; opacity: 1;}
    }

    @keyframes fadein {
      from {bottom: 0; opacity: 0;}
      to {bottom: 30px; opacity: 1;}
    }

    @-webkit-keyframes fadeout {
      from {bottom: 30px; opacity: 1;} 
      to {bottom: 0; opacity: 0;}
    }

    @keyframes fadeout {
      from {bottom: 30px; opacity: 1;}
      to {bottom: 0; opacity: 0;}
    }


    /* --- Mobile Optimization (Max Width 480px) --- */
    @media (max-width: 480px) {
      body {
        padding: 15px; 
      }
      
      /* T·ªëi ∆∞u ho√° Connect Box tr√™n mobile */
      .connect-box input {
          font-size: 16px;
          padding: 10px;
      }
      .connect-box button {
          font-size: 12px;
          padding: 6px 10px;
      }
      
      /* T·ªëi ∆∞u ho√° Playlist Item tr√™n mobile */
      .playlist-item {
          padding: 8px; 
      }
      .playlist-item span {
          font-size: 14px; 
      }
      
      /* TƒÉng th√™m padding n√∫t x√≥a tr√™n mobile */
      .playlist-item button {
          padding: 10px 14px; 
          font-size: 14px;
          min-width: 44px;
      }

      /* T·ªëi ∆∞u h√≥a T√¨m ki·∫øm/Checkbox tr√™n mobile */
      .search-box {
          flex-direction: column; 
      }
      .search-box button {
          width: 100%;
          font-size: 16px; 
          padding: 10px;
      }
      
      #searchInput, #playlistLinkInput {
        padding: 12px;
        font-size: 18px;
      }

      /* T·ªëi ∆∞u k√≠ch th∆∞·ªõc label checkbox tr√™n mobile */
      .checkbox-label {
        font-size: 16px !important;
      }
      
      /* T·ªëi ∆∞u ho√° K·∫øt qu·∫£ t√¨m ki·∫øm */
      .video-item img {
        width: 30%; 
        max-height: 80px; 
      }
      .video-title {
        font-size: 14px; 
      }
      .btn-action {
          padding: 5px 6px !important;
          font-size: 11px !important;
      }
      
      /* T·ªëi ∆∞u ho√° Control Row */
      .control-row button {
          font-size: 12px !important;
          padding: 8px 5px !important;
      }
    }
  </style>
</head>

<body>
  <div id="fixedControls" style="position: fixed; top: 10px; right: 10px; z-index: 1000; display: flex; flex-direction: row; gap: 5px; align-items: flex-end;">
    <button onclick="sendCommand('NEXT')" style="
      font-size: 12px;
      padding: 6px 12px;
      background-color: #f1c40f; 
      color: black;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      margin-right: 0; 
    ">
      ‚è≠ Qua b√†i
    </button>
    <button onclick="openTVLink()" style="
      font-size: 12px;
      padding: 6px 12px;
      background-color: #3498db;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      margin-right: 0; 
    ">
      üì∫ Link cho TV
    </button>
  </div>
  
  <h2></h2>
 
  <div id="userConnectBox" class="connect-box">
    <input id="userCodeInput" type="text" placeholder="M√£ t·ª´ TV" maxlength="5">
    <button id="connectBtn" onclick="connectRoom()" style="width: auto; margin-right: 0;">‚úÖ K·∫øt n·ªëi</button>
    <button id="logoutBtn" onclick="clearRoomCode()" style="display: none; background: #ccc; color: #333; width: auto; margin-right: 0;">üö™Tho√°t</button>
  </div>

  <h2>DANH S√ÅCH CH·ªú</h2>
  <ul id="playlist" style="list-style: none; padding: 0;"></ul>

<div class="control-row" style="margin-top: 20px; display: flex; gap: 10px; flex-wrap: wrap;">
  <button onclick="sendCommand('NEXT')">‚è≠ Qua b√†i</button> 
  <button onclick="sendCommand('PLAY')">‚ñ∂Ô∏è Play</button>
  <button onclick="sendCommand('PAUSE')">‚è∏ Pause</button>
  <button onclick="sendCommand('VOL_DOWN')">üîâ Vol -</button>
  <button onclick="sendCommand('VOL_UP')">üîä Vol +</button>
  <button style="background-color: #999;" onclick="clearPlaylist()">üóë X√≥a list</button>
</div>

  <h1>YouTube Jukebox</h1>
  <div style="margin-bottom: 16px; display: flex; align-items: center; gap: 12px;">
    <input type="checkbox" id="karaokeCheckbox" checked style="transform: scale(1.5); width: 15px; height: 15px;">
    <label for="karaokeCheckbox" class="checkbox-label">üé§ T√¨m Karaoke</label>
    <input type="checkbox" id="playlistCheckbox" style="transform: scale(1.5); width: 15px; height: 15px; margin-left: 20px;">
    <label for="playlistCheckbox" class="checkbox-label">üìÉ Playlist</label>
  </div>
  
  <input type="text" id="playlistLinkInput" placeholder="Nh·∫≠p Link/ID Playlist YouTube (list=...)" onblur="savePlaylistLink()">

  <div class="search-box">
    <input type="text" id="searchInput" placeholder="Nh·∫≠p t√™n b√†i h√°t...">
    <button onclick="newSearch()">T√¨m ki·∫øm</button>
  </div>

  <div id="searchResults"></div>
  <button id="loadMoreBtn" style="display: none;" onclick="loadMore()">HI·ªÜN TH√äM</button>
  <div id="toast"></div>


  <script>
    // --- C·∫§U H√åNH ---
    const firebaseConfig = {
      apiKey: "AIzaSyAIwBqg8EYLU7TQXfOO697C4D5p5_GeghQ",
      authDomain: "karaoke-home.firebaseapp.com",
      databaseURL: "https://karaoke-home-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "karaoke-home",
      storageBucket: "karaoke-home.firebasestorage.app",
      messagingSenderId: "285959719922",
      appId: "1:285959719922:web:6cb594ebb3ef854124796b",
      measurementId: "G-EH8DQLGWSY"
    };

    if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    
    const YOUTUBE_API_KEY = 'AIzaSyBu2W83cmzz5vhpWQsLvPzWA3F62y-5i-4'; 
    const RESULTS_PER_PAGE = 20;
    
    // H·∫±ng s·ªë cho c∆° ch·∫ø ∆∞u ti√™n ·ªïn ƒë·ªãnh
    const TIME_SCALE = 100000000000000; 
    const PRIORITY_PLAY_NOW = 1; // ∆Øu ti√™n cao nh·∫•t
    const PRIORITY_NEXT_SONG = 1.5; // ∆Øu ti√™n th·ª© hai (Ngay sau b√†i ƒëang b·∫≠t)
    
    // B·ªô ƒë·∫øm to√†n c·ª•c ƒë·ªÉ ph√° v·ª° s·ª± tr√πng l·∫∑p c·ªßa Date.now()
    let uniqueTieBreaker = 0; 

    let currentRoom = null;
    let currentPlaylistId = null;
    let nextPageToken = null; 
    let currentSearchQuery = '';
    let currentSearchMode = 'search'; 
    let playlistCache = []; 

    // --- LOGIC X·ª¨ L√ù ∆ØU TI√äN DUY NH·∫§T (FIX) ---
    function getUniquePriorityTimestamp(basePriority) {
        // TƒÉng b·ªô ƒë·∫øm ƒë·ªÉ ƒë·∫£m b·∫£o m·ªói l·∫ßn g·ªçi l√† duy nh·∫•t
        uniqueTieBreaker++;
        
        // K·∫øt h·ª£p th·ªùi gian (ms) v√† b·ªô ƒë·∫øm (ƒë∆°n v·ªã nh·ªè h∆°n) th√†nh m·ªôt s·ªë duy nh·∫•t
        // Multiply by 1000 ƒë·ªÉ t·∫°o kho·∫£ng tr·ªëng cho b·ªô ƒë·∫øm (max 999)
        const uniqueTimeValue = (Date.now() * 1000) + (uniqueTieBreaker % 1000); 
        
        // Timestamp cu·ªëi c√πng: basePriority - (uniqueTimeValue / TIME_SCALE)
        // L·ªõn h∆°n => ∆∞u ti√™n th·∫•p h∆°n (s·ªë nh·ªè h∆°n = ∆∞u ti√™n cao h∆°n)
        // B√†i ch·ªçn sau c√≥ uniqueTimeValue l·ªõn h∆°n -> gi√° tr·ªã tr·ª´ l·ªõn h∆°n -> timestamp nh·ªè h∆°n -> ∆∞u ti√™n cao h∆°n
        return basePriority - (uniqueTimeValue / TIME_SCALE);
    }
    // --- END LOGIC X·ª¨ L√ù ∆ØU TI√äN DUY NH·∫§T ---


    document.getElementById('searchInput').addEventListener('keypress', function (e) {
      if (e.key === 'Enter') {
        newSearch(); 
      }
    });
    
    // --- KH·ªûI T·∫†O V√Ä K·∫æT N·ªêI ---

    window.onload = function () {
      const storedCode = localStorage.getItem("lastRoom");
      if (storedCode && /^\d{5}$/i.test(storedCode)) {
        document.getElementById('userCodeInput').value = storedCode;
        connectRoom(storedCode);
        showToast("üîÑ ƒê√£ t·ª± ƒë·ªông k·∫øt n·ªëi");
      }
      
      const karaokeChecked = localStorage.getItem("karaokeCheckbox") === "true";
      document.getElementById("karaokeCheckbox").checked = karaokeChecked;
      document.getElementById("karaokeCheckbox").addEventListener("change", function () {
        localStorage.setItem("karaokeCheckbox", this.checked);
      });
      
      const playlistChecked = localStorage.getItem("playlistCheckbox") === "true";
      document.getElementById("playlistCheckbox").checked = playlistChecked;
      updatePlaylistUI(playlistChecked); 
      document.getElementById("playlistCheckbox").addEventListener("change", function () {
        localStorage.setItem("playlistCheckbox", this.checked);
        updatePlaylistUI(this.checked);
      });
      
      const storedPlaylistLink = localStorage.getItem("playlistLink");
      if (storedPlaylistLink) {
          document.getElementById('playlistLinkInput').value = storedPlaylistLink;
          currentPlaylistId = extractPlaylistId(storedPlaylistLink);
      }
    };
    
    function updatePlaylistUI(checked) {
        const input = document.getElementById("playlistLinkInput");
        const searchInput = document.getElementById("searchInput");
        if (checked) {
            input.style.display = "block";
            searchInput.placeholder = "Nh·∫≠p t√™n b√†i h√°t ƒë·ªÉ l·ªçc (ch·ªâ l·ªçc 50 b√†i ƒë·∫ßu) ho·∫∑c ƒë·ªÉ tr·ªëng ƒë·ªÉ xem danh s√°ch...";
            if (!currentPlaylistId) {
                showToast("‚ö†Ô∏è Vui l√≤ng nh·∫≠p Link/ID Playlist!");
            }
        } else {
            input.style.display = "none";
            searchInput.placeholder = "Nh·∫≠p t√™n b√†i h√°t...";
        }
    }
    
    function savePlaylistLink() {
        const link = document.getElementById("playlistLinkInput").value.trim();
        if (link) {
            const playlistId = extractPlaylistId(link);
            if (playlistId) {
                localStorage.setItem("playlistLink", link);
                currentPlaylistId = playlistId;
                showToast(`‚úÖ ƒê√£ l∆∞u Playlist ID: ${playlistId}`);
            } else {
                currentPlaylistId = null;
                showToast("‚ö†Ô∏è Link Playlist kh√¥ng h·ª£p l·ªá. Vui l√≤ng ki·ªÉm tra l·∫°i.");
            }
        } else {
            localStorage.removeItem("playlistLink");
            currentPlaylistId = null;
            showToast("ƒê√£ x√≥a Link Playlist ƒë√£ l∆∞u.");
        }
    }

    function connectRoom(storedCode = null) {
      const code = storedCode || document.getElementById('userCodeInput').value.trim();
      if (!/^\d{5}$/i.test(code)) {
        showToast("‚ö†Ô∏è M√£ kh√¥ng h·ª£p l·ªá (5 ch·ªØ s·ªë)");
        return;
      }
      currentRoom = code;
      localStorage.setItem("lastRoom", code);
      updateConnectUI(true);
      showToast("üîó ƒê√£ k·∫øt n·ªëi m√£ " + code);
      loadPlaylist();
    }
    
    function updateConnectUI(connected) {
      const input = document.getElementById('userCodeInput');
      const btn = document.getElementById('connectBtn');
      const logout = document.getElementById('logoutBtn');

      if (connected) {
        input.disabled = true;
        btn.innerText = "üîí ƒê√£ k·∫øt n·ªëi";
        btn.disabled = true;
        btn.style.backgroundColor = "#4caf50";
        logout.style.display = "inline-block";
      } else {
        input.disabled = false;
        btn.innerText = "‚úÖ K·∫øt n·ªëi";
        btn.disabled = false;
        btn.style.backgroundColor = "";
        logout.style.display = "none";
      }
    }

    function clearRoomCode() {
      localStorage.removeItem("lastRoom");
      currentRoom = null;
      document.getElementById('userCodeInput').value = '';
      updateConnectUI(false);
      showToast("üö™ ƒê√£ ƒëƒÉng xu·∫•t");
      document.getElementById('playlist').innerHTML = '';
    }
    
    function openTVLink() {
        window.open(
          "https://script.google.com/macros/s/AKfycbygCsBzTzqIlFljm1x453PaygverEed84GTcC1ArpocMB0j-D87m3hZ3DKn58iZilwJ/exec?page=player",
          "_blank"
        );
        showToast("ƒêang m·ªü Link TV...");
    }

    // --- ƒêI·ªÄU KHI·ªÇN & PLAYLIST FIREBASE ---

    function sendCommand(cmd) {
      if (!currentRoom) return showToast("‚ö†Ô∏è B·∫°n ch∆∞a k·∫øt n·ªëi!");
      db.ref(`rooms/${currentRoom}/command`).set({
        type: cmd,
        time: Date.now()
      });
      // C·∫£i thi·ªán Toast cho l·ªánh ƒëi·ªÅu khi·ªÉn
      const cmdMap = { 'NEXT': '‚è≠ Qua b√†i', 'PLAY': '‚ñ∂Ô∏è Play', 'PAUSE': '‚è∏ Pause', 'VOL_DOWN': 'üîâ Gi·∫£m √¢m', 'VOL_UP': 'üîä TƒÉng √¢m' };
      showToast(`‚úÖ L·ªánh: ${cmdMap[cmd] || cmd}`);
    }
    
    function clearPlaylist() {
      if (!currentRoom) return showToast("‚ö†Ô∏è B·∫°n ch∆∞a k·∫øt n·ªëi!");
      if(confirm("X√ìA H·∫æT H√ÄNG ƒê·ª¢I?")) {
        db.ref(`rooms/${currentRoom}/playlist`).remove()
          .then(() => showToast("üóë ƒê√£ x√≥a h√†ng ƒë·ª£i"))
          .catch(error => showToast("L·ªói x√≥a h√†ng ƒë·ª£i: " + error.message));
      }
    }

    function loadPlaylist() {
      if (!currentRoom) return;
      const listRef = db.ref(`rooms/${currentRoom}/playlist`).orderByChild('timestamp');
      
      listRef.on('value', (snapshot) => {
        const container = document.getElementById("playlist");
        container.innerHTML = "";
        const songs = [];
        snapshot.forEach(child => {
          songs.push({ key: child.key, ...child.val() });
        });
        
        songs.sort((a, b) => a.timestamp - b.timestamp);

        songs.forEach((s, index) => {
          const shortTitle = s.title; 
          const li = document.createElement("li");
          li.className = "playlist-item";
          li.setAttribute("data-key", s.key);

          const titleSpan = document.createElement("span");
          const prefix = index === 0 ? "‚ñ∂Ô∏è ƒêang ph√°t: " : `${index + 1}. `;
          titleSpan.textContent = `${prefix}${shortTitle}`;

          const removeBtn = document.createElement("button");
          removeBtn.textContent = "üóë";
          
          removeBtn.onclick = (event) => {
              event.stopPropagation(); 
              removeSong(s.key);
          };

          li.appendChild(titleSpan);
          li.appendChild(removeBtn);
          container.appendChild(li);
        });
        
        if (container._sortableInstance) container._sortableInstance.destroy();
        container._sortableInstance = Sortable.create(container, {
          animation: 150,
          onEnd: function (evt) {
            const keysOrder = Array.from(container.children).map(el => el.getAttribute("data-key"));
            reorderPlaylist(keysOrder);
          }
        });
      });
    }

    function removeSong(key) {
      if (!currentRoom) return showToast("‚ö†Ô∏è B·∫°n ch∆∞a k·∫øt n·ªëi!");
      db.ref(`rooms/${currentRoom}/playlist/${key}`).remove()
        .then(() => showToast("üóë ƒê√£ x√≥a b√†i"))
        .catch(error => showToast("L·ªói x√≥a b√†i: " + error.message));
    }
    
    function reorderPlaylist(keysOrder) {
      if (!currentRoom) return;
      
      const updates = {};
      const baseTimestamp = Date.now(); 
      
      // B·ªè qua b√†i ƒë·∫ßu ti√™n (b√†i ƒëang ph√°t) khi s·∫Øp x·∫øp
      for (let i = 1; i < keysOrder.length; i++) {
          const key = keysOrder[i];
          // G√°n l·∫°i timestamp l·ªõn ƒë·ªÉ ƒë∆∞a v·ªÅ ∆∞u ti√™n th·∫•p, ƒë·∫£m b·∫£o ∆Øu ti√™n v√† Play Now kh√¥ng b·ªã x√°o tr·ªôn.
          updates[`rooms/${currentRoom}/playlist/${key}/timestamp`] = baseTimestamp + i;
      }
      
      db.ref().update(updates)
        .then(() => showToast("‚úÖ ƒê√£ c·∫≠p nh·∫≠t th·ª© t·ª±"))
        .catch(error => showToast("L·ªói c·∫≠p nh·∫≠t th·ª© t·ª±: " + error.message));
    }


    // --- LOGIC T√åM KI·∫æM YOUTUBE ---
    
    function extractPlaylistId(url) {
      const match = url.match(/list=([a-zA-Z0-9_-]+)/);
      return match ? match[1] : null;
    }

    function newSearch() {
        const playlistChecked = document.getElementById("playlistCheckbox").checked;
        currentSearchQuery = document.getElementById("searchInput").value.trim();
        document.getElementById('searchResults').innerHTML = ''; 
        document.getElementById('loadMoreBtn').style.display = 'none';
        nextPageToken = null; 
        playlistCache = []; 
        
        if (playlistChecked) {
            currentSearchMode = 'playlist';
            handlePlaylistSearch(currentSearchQuery, true);
        } else {
            currentSearchMode = 'search';
            searchYouTube(currentSearchQuery, true, true);
        }
    }
    
    function loadMore() {
        if (!nextPageToken) return showToast("‚ö†Ô∏è Kh√¥ng c√≤n k·∫øt qu·∫£ ƒë·ªÉ t·∫£i!");
        
        if (currentSearchMode === 'search') {
            searchYouTube(currentSearchQuery, true, false, nextPageToken); 
        } else if (currentSearchMode === 'playlist') {
            if (currentSearchQuery === "") {
                fetchPlaylistItems(currentPlaylistId, currentSearchQuery, false, nextPageToken);
            } else {
                showToast("‚ö†Ô∏è Ch·ª©c nƒÉng L·ªçc trong Playlist kh√¥ng h·ªó tr·ª£ 'HI·ªÜN TH√äM'.");
            }
        }
    }
    
    function handlePlaylistSearch(query, isNewSearch) {
        if (!currentPlaylistId) {
             showToast("‚ö†Ô∏è Vui l√≤ng nh·∫≠p Link/ID Playlist h·ª£p l·ªá tr∆∞·ªõc!");
             return;
        }
        
        if (query === "") {
             showToast("ƒêang t·∫£i danh s√°ch Playlist...");
             fetchPlaylistItems(currentPlaylistId, query, isNewSearch);
        } else {
            if (isNewSearch) {
                showToast("‚ö†Ô∏è ƒêang t·∫£i 50 b√†i ƒë·∫ßu ƒë·ªÉ l·ªçc. H√£y ch·ªù...");
                fetchPlaylistItems(currentPlaylistId, query, isNewSearch, null, 50); 
            } else {
                 const filteredVideos = playlistCache.filter(item => 
                    item.snippet.title.toLowerCase().includes(query.toLowerCase())
                 );
                 showToast(`‚úÖ ƒê√£ l·ªçc ${filteredVideos.length} b√†i trong danh s√°ch ƒë√£ t·∫£i.`);
                 renderSearchResults(filteredVideos, true); 
                 document.getElementById('loadMoreBtn').style.display = 'none'; 
            }
        }
    }
    
    async function fetchPlaylistItems(playlistId, query, isNewSearch, pageToken = null, maxResults = RESULTS_PER_PAGE) {
        if (isNewSearch) document.getElementById('searchResults').innerHTML = 'ƒêang t·∫£i Playlist...';
        document.getElementById('loadMoreBtn').style.display = 'none';

        let url = `https://www.googleapis.com/youtube/v3/playlistItems?part=snippet,contentDetails&maxResults=${maxResults}&playlistId=${playlistId}&key=${YOUTUBE_API_KEY}`;
        if (pageToken) {
            url += `&pageToken=${pageToken}`;
        }
        
        try {
            const res = await fetch(url);
            const data = await res.json();
            
            if (res.status !== 200 || data.error) {
                 console.error("API Response Error:", data.error);
                 document.getElementById('searchResults').innerHTML = 'L·ªñI: Kh√¥ng th·ªÉ t·∫£i Playlist. Ki·ªÉm tra ID v√† Kh√≥a API.';
                 showToast("‚ö†Ô∏è L·ªói API: " + (data.error.message || "Unknown"));
                 return;
            }

            nextPageToken = data.nextPageToken;
            const newItems = data.items.filter(item => item.snippet.resourceId.kind === 'youtube#video');
            
            if (isNewSearch) {
                playlistCache = newItems;
            } else {
                playlistCache = playlistCache.concat(newItems);
            }
            
            if (query !== "") {
                const filteredVideos = playlistCache.filter(item => 
                    item.snippet.title.toLowerCase().includes(query.toLowerCase())
                );
                showToast(`‚úÖ ƒê√£ t·∫£i v√† l·ªçc ${filteredVideos.length} b√†i.`);
                renderSearchResults(filteredVideos, true); 
            } else {
                showToast(`‚úÖ ƒê√£ t·∫£i ${newItems.length} b√†i m·ªõi.`);
                
                renderSearchResults(newItems, isNewSearch); 
            }
            
            if (nextPageToken && query === "") {
                document.getElementById('loadMoreBtn').style.display = 'block';
            } else {
                document.getElementById('loadMoreBtn').style.display = 'none';
            }

        } catch (e) {
            document.getElementById('searchResults').innerHTML = '';
            showToast("‚ö†Ô∏è L·ªói m·∫°ng/API: " + e.message);
            nextPageToken = null;
        }
    }

    async function searchYouTube(query, useKaraokeCheckbox, isNewSearch, pageToken = null) {
      const karaokeChecked = document.getElementById("karaokeCheckbox").checked && useKaraokeCheckbox;
      
      if (!query && isNewSearch) return; 
      
      let finalQuery = query;
      if (karaokeChecked) finalQuery += " karaoke";

      if (isNewSearch) {
        document.getElementById('searchResults').innerHTML = 'ƒêang t√¨m ki·∫øm...';
      } else {
        document.getElementById('loadMoreBtn').innerText = 'ƒêang t·∫£i...';
      }

      let url = `https://www.googleapis.com/youtube/v3/search?part=snippet&type=video&maxResults=${RESULTS_PER_PAGE}&q=${encodeURIComponent(finalQuery)}&key=${YOUTUBE_API_KEY}`;
      if (pageToken) {
        url += `&pageToken=${pageToken}`;
      }

      try {
        const res = await fetch(url);
        const data = await res.json();
        
        if (res.status !== 200 || data.error) {
             document.getElementById('searchResults').innerHTML = 'L·ªñI: Kh√¥ng th·ªÉ t√¨m ki·∫øm. Ki·ªÉm tra Kh√≥a API.';
             showToast("‚ö†Ô∏è L·ªói API: " + (data.error.message || "Unknown"));
             return;
        }

        nextPageToken = data.nextPageToken;
        
        if (isNewSearch) {
            document.getElementById('searchResults').innerHTML = ''; 
        }
        
        renderSearchResults(data.items, isNewSearch);
        showToast(`‚úÖ T√¨m ki·∫øm ho√†n t·∫•t. K·∫øt qu·∫£: ${data.items.length} b√†i.`);
        
        if (nextPageToken) {
            document.getElementById('loadMoreBtn').style.display = 'block';
            document.getElementById('loadMoreBtn').innerText = 'HI·ªÜN TH√äM';
        } else {
            document.getElementById('loadMoreBtn').style.display = 'none';
        }

      } catch (e) {
        document.getElementById('searchResults').innerHTML = isNewSearch ? '' : document.getElementById('searchResults').innerHTML;
        showToast("‚ö†Ô∏è L·ªói m·∫°ng/API: " + e.message);
        document.getElementById('loadMoreBtn').style.display = 'none';
      }
    }

    // --- H√ÄM RENDER K·∫æT QU·∫¢ ---
    function renderSearchResults(videos, isNewSearch) {
      const container = document.getElementById('searchResults');
      if (isNewSearch) {
          container.innerHTML = ''; 
      }

      if(!videos || videos.length === 0) {
          if (isNewSearch) container.innerHTML = 'Kh√¥ng t√¨m th·∫•y k·∫øt qu·∫£ n√†o.';
          return;
      }

      videos.forEach(item => {
        const vid = item.id ? item.id.videoId : (item.snippet.resourceId ? item.snippet.resourceId.videoId : null);
        
        if (!vid) return; 

        const title = item.snippet.title;
        const img = item.snippet.thumbnails.medium.url;

        const videoDiv = document.createElement('div');
        videoDiv.className = 'video-item';

        const safeTitle = encodeURIComponent(title);

        videoDiv.innerHTML = `
          <img src="${img}">
          <div class="video-info">
            <div class="video-title">${title}</div>
            <div class="action-buttons-row">
              <button class="btn-action" onclick="submitSong('${vid}', decodeURIComponent('${safeTitle}'))">G·ª≠i b√†i</button>
              <button class="btn-action btn-priority" onclick="submitPrioritySong('${vid}', decodeURIComponent('${safeTitle}'))">∆Øu ti√™n</button>
              <button class="btn-action btn-playnow" onclick="submitPrioritySong2('${vid}', decodeURIComponent('${safeTitle}'))">Play Now</button>
            </div>
          </div>
        `;
        container.appendChild(videoDiv);
      });
    }

    // --- CH·ª®C NƒÇNG FIREBASE ---

    function submitSong(videoId, title) {
      if (!currentRoom) return showToast("‚ö†Ô∏è B·∫°n ch∆∞a k·∫øt n·ªëi!");
      const song = { videoId: videoId, title: title, timestamp: Date.now() }; // Timestamp l·ªõn (∆∞u ti√™n th·∫•p nh·∫•t)
      db.ref(`rooms/${currentRoom}/playlist`).push(song)
        .then(() => showToast("‚úÖ ƒê√£ g·ª≠i b√†i th∆∞·ªùng"))
        .catch(error => showToast("L·ªói g·ª≠i b√†i: " + error.message));
    }

    // ƒê√É FIX: Logic ∆Øu ti√™n ƒë·ªÉ ƒë·∫∑t ngay sau b√†i ƒëang b·∫≠t (Priority 1.5) v√† ƒë·∫£m b·∫£o th·ª© t·ª±
    function submitPrioritySong(videoId, title) {
      if (!currentRoom) return showToast("‚ö†Ô∏è B·∫°n ch∆∞a k·∫øt n·ªëi!");
      
      const timestamp = getUniquePriorityTimestamp(PRIORITY_NEXT_SONG);
      
      const song = { videoId: videoId, title: title, timestamp: timestamp }; 
      db.ref(`rooms/${currentRoom}/playlist`).push(song)
        .then(() => showToast("‚úÖ ƒê√£ g·ª≠i ∆∞u ti√™n (Ngay sau b√†i ƒëang b·∫≠t)"))
        .catch(error => showToast("L·ªói g·ª≠i ∆∞u ti√™n: " + error.message));
    }
    
    // ƒê√É FIX: Logic Play Now ƒë·ªÉ ph√°t ngay (Priority 1) v√† ƒë·∫£m b·∫£o th·ª© t·ª±
    function submitPrioritySong2(videoId, title) {
      if (!currentRoom) return showToast("‚ö†Ô∏è B·∫°n ch∆∞a k·∫øt n·ªëi!");
      
      const timestamp = getUniquePriorityTimestamp(PRIORITY_PLAY_NOW);

      const song = { videoId: videoId, title: title, timestamp: timestamp };
      db.ref(`rooms/${currentRoom}/playlist`).push(song)
        .then(() => {
            // Player.html s·∫Ω t·ª± ƒë·ªông ph√°t b√†i n√†y ngay l·∫≠p t·ª©c do timestamp th·∫•p nh·∫•t (nh·ªè h∆°n 1.0)
            showToast("‚úÖ ƒê√£ g·ª≠i Play Now (Ph√°t ngay)"); 
        })
        .catch(error => {
            showToast("L·ªói g·ª≠i Play Now: " + error.message);
        });
    }

    function showToast(message) {
      const toast = document.getElementById('toast');
      toast.textContent = message;
      toast.className = 'show';
      setTimeout(() => toast.className = '', 2000);
    }
  </script>
</body>
</html>
