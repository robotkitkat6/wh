<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
  <title>YouTube Jukebox Remote</title>
  <style>
    body {
      font-family: sans-serif;
      background: #f7f7f7;
      padding: 35px;
      margin: 0;
    }

    .playlist-item {
      padding: 1px;
      margin-bottom: 12px;
      background: white;
      border-radius: 12px;
      font-size: 40px;
      font-weight: 500;
      box-shadow: 0 1px 2px rgba(0,0,0,0.1);
      cursor: grab;
      /* ƒêi·ªÅu ch·ªânh cho danh s√°ch ch·ªù trong remote.html */
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 15px;
    }
    
    .playlist-item span {
        font-size: 24px;
    }

    h1 {
      color: #cc0000;
      font-size: 26px;
      text-align: center;
      margin-bottom: 20px;
    }
    
    h2 {
        font-size: 20px;
        color: #333;
    }

    #searchInput {
      width: 100%;
      padding: 32px;
      font-size: 38px;
      margin-bottom: 10px;
      box-sizing: border-box;
      border: 1px solid #ccc; /* Th√™m border cho input */
    }

    button {
      padding: 26px;
      font-size: 24px;
      background: #cc0000;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      margin-right: 10px;
      transition: background 0.2s, transform 0.1s;
    }
    
    /* Thi·∫øt k·∫ø ri√™ng cho n√∫t trong danh s√°ch ch·ªù */
    .playlist-item button {
        padding: 6px 12px;
        font-size: 20px;
        background: #e74c3c;
        margin-right: 0;
    }

    .btn-no {
      background-color: #f39c12;
      color: white;
      padding: 1px;
      font-size: 1px;
    }

    button:hover {
      background: #a80000;
    }

    button:active {
      background: #880000;
      transform: scale(0.88);
      outline: none;
    }

    #loadMoreBtn {
      width: 100%;
      margin-top: 38px;
    }

    .video-item {
      display: flex;
      align-items: center;
      background: white;
      margin-bottom: 12px;
      border-radius: 10px;
      overflow: hidden;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .video-item img {
      /* ƒêi·ªÅu ch·ªânh l·∫°i k√≠ch th∆∞·ªõc ·∫£nh cho remote.html */
      width: 30%; 
      max-width: 150px;
      height: auto;
      object-fit: cover;
    }

    .video-info {
      padding: 10px;
      flex: 1;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
    }

    .video-title {
      font-size: 20px; /* Nh·ªè h∆°n cho remote */
      margin-bottom: 8px;
      font-weight: bold;
    }

    .button-group {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }

    /* ƒê·ªãnh d·∫°ng l·∫°i n√∫t trong k·∫øt qu·∫£ t√¨m ki·∫øm */
    .video-item button {
        padding: 10px;
        font-size: 16px;
        margin-right: 0;
    }

    #toast {
      position: fixed;
      top: 1px;
      left: 50%;
      transform: translateX(-50%);
      background-color: #333;
      color: white;
      padding: 20px 30px;
      border-radius: 8px;
      font-size: 24px;
      opacity: 0;
      transition: opacity 0.5s ease;
      z-index: 9999;
    }

    #toast.show {
        visibility: visible;
        opacity: 1;
    }
    
    .connect-box {
        display: flex;
        gap: 16px; 
        align-items: center; 
        margin-bottom: 16px;
    }

    .connect-box input {
        font-size: 30px; 
        padding: 24px; 
        flex: 1;
        box-sizing: border-box;
        margin-bottom: 0;
    }
    
    .control-row button {
        background-color: #4caf50; 
        padding: 16px 18px; 
        font-size: 19px;
        margin-right: 0;
        flex-grow: 1;
    }

    @media (max-width: 480px) {
      .video-title {
        font-size: 16px;
      }
      .video-item {
        flex-direction: column;
        align-items: flex-start;
      }
      .video-item img {
        width: 100%;
        max-height: 180px;
      }
      .video-item .button-group button {
        width: 100%;
        margin-top: 16px;
      }
      .connect-box input {
          font-size: 18px;
          padding: 12px;
      }
      .control-row button {
          font-size: 16px;
          padding: 10px;
      }
    }
  </style>
</head>

<body>
  <div style="position: fixed; top: 10px; right: 10px; z-index: 1000;">
    <button onclick="openTVLink()" style="
      font-size: 12px;
      padding: 6px 12px;
      background-color: #3498db;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      margin-right: 0; /* Lo·∫°i b·ªè margin th·ª´a */
    ">
      üì∫ Link cho TV
    </button>
  </div>
  
  <h2></h2>
 
  <div id="userConnectBox" class="connect-box">
    <input id="userCodeInput" type="text" placeholder="M√£ t·ª´ TV" maxlength="5">
    <button id="connectBtn" onclick="connectRoom()" style="font-size: 16px; width: auto; margin-right: 0;">‚úÖ K·∫øt n·ªëi</button>
    <button id="logoutBtn" onclick="clearRoomCode()" style="display: none; font-size: 16px; background: #ccc; color: #333; width: auto; margin-right: 0;">üö™Tho√°t</button>
  </div>

  <h2>DANH S√ÅCH CH·ªú</h2>
  <ul id="playlist" style="list-style: none; padding: 0;"></ul>

<div class="control-row" style="margin-top: 20px; display: flex; gap: 10px; flex-wrap: wrap;">
  <button onclick="sendCommand('NEXT')">‚è≠ Qua b√†i</button>
  <button onclick="sendCommand('PLAY')">‚ñ∂Ô∏è Play</button>
  <button onclick="sendCommand('PAUSE')">‚è∏ Pause</button>
  <button onclick="sendCommand('VOL_DOWN')">üîâ Volume -</button>
  <button onclick="sendCommand('VOL_UP')">üîä Volume +</button>
  <button style="background-color: #999;" onclick="clearPlaylist()">üóë X√≥a list ƒë·ª£i</button>
</div>

  <h1>YouTube Jukebox</h1>
  <div style="margin-bottom: 16px; display: flex; align-items: center; gap: 12px;">
    <input type="checkbox" id="karaokeCheckbox" checked style="transform: scale(2); width: 20px; height: 20px;">
    <label for="karaokeCheckbox" style="font-size: 24px;">üé§ T√¨m Karaoke</label>
    </div>
  <input type="text" id="searchInput" placeholder="Nh·∫≠p t√™n b√†i h√°t...">
  <button onclick="searchYouTube()">T√¨m ki·∫øm</button>

  <div id="searchResults"></div>
  <div id="toast"></div>


  <script>
    // --- C·∫§U H√åNH FIREBASE ---
    const firebaseConfig = {
      apiKey: "AIzaSyAIwBqg8EYLU7TQXfOO697C4D5p5_GeghQ", // D√πng key c≈©
      authDomain: "karaoke-home.firebaseapp.com",
      databaseURL: "https://karaoke-home-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "karaoke-home",
      storageBucket: "karaoke-home.firebasestorage.app",
      messagingSenderId: "285959719922",
      appId: "1:285959719922:web:6cb594ebb3ef854124796b",
      measurementId: "G-EH8DQLGWSY"
    };

    if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    
    // Key API YouTube (S·ª≠ d·ª•ng t·∫°m key t·ª´ file c≈©)
    const YOUTUBE_API_KEY = 'AIzaSyBu2W83cmzz5vhpWQsLvPzWA3F62y-5i-4';

    let currentRoom = null;

    document.getElementById('searchInput').addEventListener('keypress', function (e) {
      if (e.key === 'Enter') {
        searchYouTube();
      }
    });
    
    // --- KH·ªûI T·∫†O V√Ä K·∫æT N·ªêI ---
    window.onload = function () {
      const storedCode = localStorage.getItem("lastRoom");
      if (storedCode && /^\d{5}$/.test(storedCode)) {
        document.getElementById('userCodeInput').value = storedCode;
        connectRoom(storedCode);
        showToast("üîÑ ƒê√£ t·ª± ƒë·ªông k·∫øt n·ªëi");
      }
      
      const karaokeChecked = localStorage.getItem("karaokeCheckbox") === "true";
      document.getElementById("karaokeCheckbox").checked = karaokeChecked;
      document.getElementById("karaokeCheckbox").addEventListener("change", function () {
        localStorage.setItem("karaokeCheckbox", this.checked);
      });
    };

    function updateConnectUI(connected) {
      const input = document.getElementById('userCodeInput');
      const btn = document.getElementById('connectBtn');
      const logout = document.getElementById('logoutBtn');

      if (connected) {
        input.disabled = true;
        btn.innerText = "üîí ƒê√£ k·∫øt n·ªëi";
        btn.disabled = true;
        btn.style.backgroundColor = "#4caf50";
        logout.style.display = "inline-block";
      } else {
        input.disabled = false;
        btn.innerText = "‚úÖ K·∫øt n·ªëi";
        btn.disabled = false;
        btn.style.backgroundColor = "";
        logout.style.display = "none";
      }
    }

    function connectRoom(storedCode = null) {
      const code = storedCode || document.getElementById('userCodeInput').value.trim();
      if (!/^\d{5}$/.test(code)) {
        showToast("‚ö†Ô∏è M√£ kh√¥ng h·ª£p l·ªá (5 ch·ªØ s·ªë)");
        return;
      }
      currentRoom = code;
      localStorage.setItem("lastRoom", code);
      updateConnectUI(true);
      showToast("üîó ƒê√£ k·∫øt n·ªëi m√£ " + code);
      loadPlaylist();
    }

    function clearRoomCode() {
      localStorage.removeItem("lastRoom");
      currentRoom = null;
      document.getElementById('userCodeInput').value = '';
      updateConnectUI(false);
      showToast("üö™ ƒê√£ ƒëƒÉng xu·∫•t");
      document.getElementById('playlist').innerHTML = ''; // X√≥a danh s√°ch ch·ªù
    }
    
    function openTVLink() {
        // D√πng link m·∫´u c·ªßa remote1.html v√¨ kh√¥ng c√≥ link th·ª±c t·∫ø c·ªßa player.html
        window.open(
          "https://script.google.com/macros/s/AKfycbygCsBzTzqIlFljm1x453PaygverEed84GTcC1ArpocMB0j-D87m3hZ3DKn58iZilwJ/exec?page=player",
          "_blank"
        );
    }

    // --- ƒêI·ªÄU KHI·ªÇN & PLAYLIST ---
    function sendCommand(cmd) {
      if (!currentRoom) return showToast("‚ö†Ô∏è B·∫°n ch∆∞a k·∫øt n·ªëi!");
      db.ref(`rooms/${currentRoom}/command`).set({
        type: cmd,
        time: Date.now()
      });
      showToast(cmd);
    }
    
    function clearPlaylist() {
      if (!currentRoom) return showToast("‚ö†Ô∏è B·∫°n ch∆∞a k·∫øt n·ªëi!");
      if(confirm("X√ìA H·∫æT H√ÄNG ƒê·ª¢I?")) {
        db.ref(`rooms/${currentRoom}/playlist`).remove();
        showToast("üóë ƒê√£ x√≥a h√†ng ƒë·ª£i");
      }
    }

    function loadPlaylist() {
      if (!currentRoom) return;
      const listRef = db.ref(`rooms/${currentRoom}/playlist`).orderByChild('timestamp');
      
      listRef.on('value', (snapshot) => {
        const container = document.getElementById("playlist");
        container.innerHTML = "";
        const songs = [];
        snapshot.forEach(child => {
          songs.push({ key: child.key, ...child.val() });
        });
        
        songs.sort((a, b) => a.timestamp - b.timestamp);

        songs.forEach((s, index) => {
          const shortTitle = s.title.slice(0, 30);
          const li = document.createElement("li");
          li.className = "playlist-item";
          li.setAttribute("data-key", s.key); // D√πng key ƒë·ªÉ reorder

          const titleSpan = document.createElement("span");
          const prefix = index === 0 ? "‚ñ∂Ô∏è ƒêang ph√°t: " : `${index + 1}. `;
          titleSpan.textContent = `${prefix}${shortTitle}`;

          const removeBtn = document.createElement("button");
          removeBtn.textContent = "üóë";
          removeBtn.onclick = () => removeSong(s.key);

          li.appendChild(titleSpan);
          li.appendChild(removeBtn);
          container.appendChild(li);
        });
        
        // K√≠ch ho·∫°t SortableJS sau khi render
        if (container._sortableInstance) container._sortableInstance.destroy();
        container._sortableInstance = Sortable.create(container, {
          animation: 150,
          onEnd: function (evt) {
            const keysOrder = Array.from(container.children).map(el => el.getAttribute("data-key"));
            reorderPlaylist(keysOrder);
          }
        });
      });
    }

    function removeSong(key) {
      if (!currentRoom) return;
      db.ref(`rooms/${currentRoom}/playlist/${key}`).remove();
      showToast("üóë ƒê√£ x√≥a b√†i");
    }
    
    function reorderPlaylist(keysOrder) {
      if (!currentRoom) return;
      // D·ª±a v√†o keysOrder, c·∫≠p nh·∫≠t timestamp ƒë·ªÉ Firebase t·ª± s·∫Øp x·∫øp l·∫°i
      // L∆∞u √Ω: B√†i ƒëang ph√°t (keysOrder[0]) kh√¥ng n√™n thay ƒë·ªïi timestamp
      
      const updates = {};
      const baseTimestamp = Date.now(); 
      
      // B·ªè qua b√†i ƒë·∫ßu ti√™n ƒëang ph√°t
      for (let i = 1; i < keysOrder.length; i++) {
          const key = keysOrder[i];
          // C·∫≠p nh·∫≠t timestamp cho c√°c b√†i c√≤n l·∫°i theo v·ªã tr√≠ m·ªõi
          updates[`rooms/${currentRoom}/playlist/${key}/timestamp`] = baseTimestamp + i;
      }
      
      db.ref().update(updates)
        .then(() => showToast("‚úÖ ƒê√£ c·∫≠p nh·∫≠t th·ª© t·ª±"))
        .catch(error => showToast("L·ªói c·∫≠p nh·∫≠t th·ª© t·ª±: " + error.message));
    }


    // --- T√åM KI·∫æM & TH√äM B√ÄI H√ÅT ---
    async function searchYouTube() {
      const karaokeChecked = document.getElementById("karaokeCheckbox").checked;
      let query = document.getElementById('searchInput').value.trim();
      
      document.getElementById('searchResults').innerHTML = ''; // X√≥a k·∫øt qu·∫£ c≈©

      if (!query) return;
      if (karaokeChecked) query += " karaoke";

      const url = `https://www.googleapis.com/youtube/v3/search?part=snippet&type=video&maxResults=10&q=${encodeURIComponent(query)}&key=${YOUTUBE_API_KEY}`;
      
      try {
        const res = await fetch(url);
        const data = await res.json();
        renderSearchResults(data.items);
      } catch (e) {
        showToast("‚ö†Ô∏è L·ªói t√¨m ki·∫øm: " + e.message);
      }
    }

    function renderSearchResults(videos) {
      const container = document.getElementById('searchResults');
      if(!videos) return;

      videos.forEach(item => {
        const vid = item.id.videoId;
        const title = item.snippet.title;
        const img = item.snippet.thumbnails.medium.url;

        const videoDiv = document.createElement('div');
        videoDiv.className = 'video-item';

        const safeTitle = encodeURIComponent(title);

        videoDiv.innerHTML = `
          <img src="${img}">
          <div class="video-info">
            <div class="video-title">${title}</div>
            <div class="button-group">
              <button onclick="submitSong('${vid}', decodeURIComponent('${safeTitle}'))">G·ª≠i b√†i</button>
              <button class="btn-no" style="background:#f39c12; padding:10px; font-size:16px;" onclick="submitPrioritySong('${vid}', decodeURIComponent('${safeTitle}'))">∆Øu ti√™n</button>
            </div>
            <div class="button-group" style="margin-top: 10px;">
              <button style="background:#007bff;" onclick="submitPrioritySong2('${vid}', decodeURIComponent('${safeTitle}'))">Play Now</button>
            </div>
          </div>
        `;
        container.appendChild(videoDiv);
      });
    }

    function submitSong(videoId, title) {
      if (!currentRoom) return showToast("‚ö†Ô∏è B·∫°n ch∆∞a k·∫øt n·ªëi!");
      const song = { videoId: videoId, title: title, timestamp: Date.now() };
      db.ref(`rooms/${currentRoom}/playlist`).push(song);
      showToast("‚úÖ ƒê√£ g·ª≠i b√†i");
    }

    function submitPrioritySong(videoId, title) {
      if (!currentRoom) return showToast("‚ö†Ô∏è B·∫°n ch∆∞a k·∫øt n·ªëi!");
      // G·ª≠i b√†i v·ªõi timestamp r·∫•t th·∫•p nh∆∞ng l·ªõn h∆°n 0, ƒë·ªÉ x·∫øp sau b√†i ƒëang ph√°t
      const song = { videoId: videoId, title: title, timestamp: 2 }; 
      db.ref(`rooms/${currentRoom}/playlist`).push(song);
      showToast("‚úÖ ƒê√£ g·ª≠i ∆∞u ti√™n");
    }
    
    function submitPrioritySong2(videoId, title) {
      if (!currentRoom) return showToast("‚ö†Ô∏è B·∫°n ch∆∞a k·∫øt n·ªëi!");
      // G·ª≠i b√†i v·ªõi timestamp = 1, ƒë·ªÉ x·∫øp l√™n ngay v·ªã tr√≠ th·ª© 2 (b√†i ƒëang ph√°t c√≥ timestamp 0)
      const song = { videoId: videoId, title: title, timestamp: 1 };
      db.ref(`rooms/${currentRoom}/playlist`).push(song);
      showToast("‚úÖ ƒê√£ g·ª≠i Play Now");
    }

    function showToast(message) {
      const toast = document.getElementById('toast');
      toast.textContent = message;
      toast.className = 'show';
      setTimeout(() => toast.className = '', 2000);
    }
  </script>
</body>
</html>
