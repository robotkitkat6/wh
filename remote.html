<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Remote Firebase Karaoke</title>
  <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

  <style>
    body { font-family: sans-serif; background: #f7f7f7; padding: 20px; margin: 0; }
    .playlist-item { background: white; margin-bottom: 10px; padding: 15px; border-radius: 8px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 1px 2px rgba(0,0,0,0.1); }
    input, button { padding: 15px; font-size: 16px; border-radius: 5px; margin-bottom: 10px; }
    input { width: 100%; box-sizing: border-box; border: 1px solid #ccc; }
    button { background: #cc0000; color: white; border: none; cursor: pointer; flex-grow: 1; }
    .control-group { display: flex; gap: 5px; margin-bottom: 20px; flex-wrap: wrap; }
    .video-item { display: flex; gap: 10px; background: white; margin-bottom: 10px; padding: 10px; border-radius: 8px; }
    .video-item img { width: 120px; height: 90px; object-fit: cover; border-radius: 4px; }
    .video-info { flex: 1; display: flex; flex-direction: column; justify-content: space-between; }
    .btn-group { display: flex; gap: 5px; margin-top: 5px; }
    .btn-small { padding: 8px; font-size: 14px; background: #007bff; }
    .btn-del { background: #e74c3c; padding: 8px 12px; margin-left: 10px; }
    #toast { position: fixed; top: 10px; left: 50%; transform: translateX(-50%); background: #333; color: white; padding: 10px 20px; border-radius: 5px; opacity: 0; transition: opacity 0.5s; pointer-events: none; z-index: 999; }
  </style>
</head>
<body>
  <div id="toast">ThÃ´ng bÃ¡o</div>

  <div style="display: flex; gap: 10px;">
    <input type="text" id="userCodeInput" placeholder="Nháº­p mÃ£ TV (vÃ­ dá»¥: 12345)">
    <button onclick="connectRoom()" style="background: #2ecc71; width: auto;">Káº¿t ná»‘i</button>
  </div>

  <div class="control-group">
    <button onclick="sendCommand('PLAY')">â–¶ Play</button>
    <button onclick="sendCommand('PAUSE')">â¸ Pause</button>
    <button onclick="sendCommand('NEXT')">â­ Next</button>
    <button onclick="sendCommand('VOL_UP')">ğŸ”Š +Vol</button>
    <button onclick="sendCommand('VOL_DOWN')">ğŸ”‰ -Vol</button>
  </div>

  <h3>ğŸ” TÃ¬m bÃ i hÃ¡t</h3>
  <div style="display: flex; align-items: center; margin-bottom: 10px;">
    <input type="checkbox" id="karaokeCheckbox" checked style="width: 20px; height: 20px;">
    <label for="karaokeCheckbox" style="font-size: 18px; margin-left: 8px;">Cháº¿ Ä‘á»™ Karaoke</label>
  </div>
  <div style="display: flex; gap: 5px;">
    <input type="text" id="searchInput" placeholder="Nháº­p tÃªn bÃ i hÃ¡t...">
    <button onclick="searchYouTube()" style="width: auto;">TÃ¬m</button>
  </div>
  <div id="searchResults"></div>

  <h3>ğŸ“œ Danh sÃ¡ch chá» <button onclick="clearPlaylist()" class="btn-small" style="background:#999; width:auto; float:right;">XÃ³a háº¿t</button></h3>
  <ul id="playlist" style="list-style: none; padding: 0;"></ul>

<script>
  // --- Cáº¤U HÃŒNH FIREBASE (DÃN Cá»¦A Báº N VÃ€O ÄÃ‚Y) ---
// For Firebase JS SDK v7.20.0 and later, measurementId is optional
const firebaseConfig = {
  apiKey: "AIzaSyAIwBqg8EYLU7TQXfOO697C4D5p5_GeghQ",
  authDomain: "karaoke-home.firebaseapp.com",
  databaseURL: "https://karaoke-home-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "karaoke-home",
  storageBucket: "karaoke-home.firebasestorage.app",
  messagingSenderId: "285959719922",
  appId: "1:285959719922:web:6cb594ebb3ef854124796b",
  measurementId: "G-EH8DQLGWSY"
};
  // ----------------------------------------------

  // Khá»Ÿi táº¡o Firebase
  if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
  const db = firebase.database();
  
  // API Key YouTube (DÃ¹ng key cÅ© trong file cá»§a báº¡n hoáº·c táº¡o má»›i)
  const YOUTUBE_API_KEY = 'AIzaSyBu2W83cmzz5vhpWQsLvPzWA3F62y-5i-4'; // Táº­n dá»¥ng luÃ´n key cá»§a Firebase náº¿u nÃ³ chung project Google Cloud
  // Hoáº·c dÃ¹ng key cá»©ng: const YOUTUBE_API_KEY = 'AIzaSyBu2W83cmzz5vhpWQsLvPzWA3F62y-5i-4';

  let currentRoom = localStorage.getItem('lastRoom') || '';
  if(currentRoom) document.getElementById('userCodeInput').value = currentRoom;

  // Káº¿t ná»‘i phÃ²ng vÃ  láº¯ng nghe thay Ä‘á»•i playlist
  function connectRoom() {
    const code = document.getElementById('userCodeInput').value.trim();
    if (!code) return alert("Nháº­p mÃ£ phÃ²ng!");
    currentRoom = code;
    localStorage.setItem('lastRoom', code);
    showToast(`ÄÃ£ káº¿t ná»‘i phÃ²ng ${code}`);
    loadPlaylist();
  }

  // Gá»­i lá»‡nh Ä‘iá»u khiá»ƒn
  function sendCommand(cmd) {
    if (!currentRoom) return alert("ChÆ°a káº¿t ná»‘i!");
    db.ref(`rooms/${currentRoom}/command`).set({
      type: cmd,
      time: Date.now()
    });
  }

  // TÃ¬m kiáº¿m YouTube (Gá»i trá»±c tiáº¿p API, khÃ´ng qua server trung gian)
  async function searchYouTube() {
    let query = document.getElementById('searchInput').value;
    if (!query) return;
    if (document.getElementById('karaokeCheckbox').checked) query += " karaoke";

    const url = `https://www.googleapis.com/youtube/v3/search?part=snippet&type=video&maxResults=10&q=${encodeURIComponent(query)}&key=${YOUTUBE_API_KEY}`;
    
    try {
      const res = await fetch(url);
      const data = await res.json();
      renderSearchResults(data.items);
    } catch (e) {
      alert("Lá»—i tÃ¬m kiáº¿m: " + e.message);
    }
  }

  function renderSearchResults(videos) {
    const container = document.getElementById('searchResults');
    container.innerHTML = '';
    if(!videos) return;

    videos.forEach(item => {
      const vid = item.id.videoId;
      const title = item.snippet.title;
      const img = item.snippet.thumbnails.medium.url;

      const div = document.createElement('div');
      div.className = 'video-item';
      div.innerHTML = `
        <img src="${img}">
        <div class="video-info">
          <b>${title}</b>
          <div class="btn-group">
            <button class="btn-small" onclick="addSong('${vid}', '${title.replace(/'/g, "\\'")}')">â• Chá»n bÃ i</button>
            <button class="btn-small" style="background:#f39c12" onclick="prioritizeSong('${vid}', '${title.replace(/'/g, "\\'")}')">âš¡ Æ¯u tiÃªn</button>
          </div>
        </div>
      `;
      container.appendChild(div);
    });
  }

  // ThÃªm bÃ i vÃ o Firebase
  function addSong(vid, title) {
    if (!currentRoom) return alert("ChÆ°a káº¿t ná»‘i!");
    const song = { videoId: vid, title: title, timestamp: Date.now() };
    db.ref(`rooms/${currentRoom}/playlist`).push(song);
    showToast("ÄÃ£ thÃªm bÃ i!");
  }

  // Æ¯u tiÃªn (ChÃ¨n lÃªn Ä‘áº§u danh sÃ¡ch chÆ°a hÃ¡t)
  async function prioritizeSong(vid, title) {
    if (!currentRoom) return alert("ChÆ°a káº¿t ná»‘i!");
    // Firebase khÃ´ng há»— trá»£ insertAt, ta pháº£i láº¥y list vá» rá»“i xá»­ lÃ½ (hoáº·c dÃ¹ng priority value Ã¢m)
    // CÃ¡ch Ä‘Æ¡n giáº£n: Set priority timestamp cá»±c nhá»
    const song = { videoId: vid, title: title, timestamp: 1 }; 
    // LÆ°u Ã½: Logic sáº¯p xáº¿p sáº½ xá»­ lÃ½ á»Ÿ pháº§n loadPlaylist
    db.ref(`rooms/${currentRoom}/playlist`).push(song);
    showToast("ÄÃ£ Æ°u tiÃªn!");
  }

  // Láº¯ng nghe Playlist thay Ä‘á»•i
  function loadPlaylist() {
    if (!currentRoom) return;
    const listRef = db.ref(`rooms/${currentRoom}/playlist`).orderByChild('timestamp');
    
    listRef.on('value', (snapshot) => {
      const list = document.getElementById('playlist');
      list.innerHTML = '';
      const songs = [];
      snapshot.forEach(child => {
        songs.push({ key: child.key, ...child.val() });
      });
      
      // Sáº¯p xáº¿p client side (náº¿u cáº§n logic phá»©c táº¡p hÆ¡n)
      songs.sort((a, b) => a.timestamp - b.timestamp);

      songs.forEach((s, index) => {
        const li = document.createElement('li');
        li.className = 'playlist-item';
        // BÃ i Ä‘áº§u tiÃªn Ä‘ang phÃ¡t
        const prefix = index === 0 ? "â–¶ï¸ Äang phÃ¡t: " : `${index}. `;
        li.innerHTML = `<span>${prefix}${s.title}</span> <button class="btn-del" onclick="removeSong('${s.key}')">ğŸ—‘</button>`;
        list.appendChild(li);
      });
    });
  }

  function removeSong(key) {
    db.ref(`rooms/${currentRoom}/playlist/${key}`).remove();
  }

  function clearPlaylist() {
    if(confirm("XÃ³a háº¿t hÃ ng Ä‘á»£i?")) db.ref(`rooms/${currentRoom}/playlist`).remove();
  }

  function showToast(msg) {
    const t = document.getElementById('toast');
    t.textContent = msg;
    t.style.opacity = 1;
    setTimeout(() => t.style.opacity = 0, 2000);
  }
</script>
</body>
</html>