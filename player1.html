<!DOCTYPE html>
<html>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <head>
    <base target="_top">
    <title>Karaoke Player</title>
    <style>
      /* --- STYLE T·ª™ PLAYER1.HTML --- */
      #currentTitle {
        position: relative;
        width: 200px;
        height: 24px;
        overflow: hidden;
        white-space: nowrap;
      }

      #scrollingTitle {
        position: absolute;
        white-space: nowrap;
        display: inline-block;
        animation: scroll-left 12s linear infinite;
        color: #00ffcc;
        font-weight: bold;
      }

      @keyframes scroll-left {
        0% { left: 100%; }
        100% { left: -100%; }
      }

      body {
        background-color: #000;
        color: white;
        font-family: Arial, sans-serif;
        margin: 0;
        padding: 0;
        overflow: hidden;
      }

      #player {
        position: absolute;
        top: 0;
        left: 0;
        width: 100vw;
        height: 100vh;
        z-index: 0; /* ƒê·ªïi th√†nh 0 ƒë·ªÉ UI n·∫±m tr√™n */
      }

      #uiContainer {
        position: absolute;
        top: 10px;
        right: 10px;
        background: rgba(0, 0, 0, 0.5); /* TƒÉng ƒë·ªô ƒë·∫≠m n·ªÅn cho d·ªÖ nh√¨n */
        padding: 12px;
        border-radius: 12px;
        max-width: 270px;
        z-index: 2;
      }

      #controls {
        display: flex;
        align-items: center;
        gap: 10px;
        margin-bottom: 10px;
      }

      #currentTitle {
        max-width: 180px;
        overflow: hidden;
        white-space: nowrap;
      }

      #playlistDisplay {
        margin: 0;
        padding-left: 14px;
        font-size: 14px; 
        font-weight: normal; 
        color: rgba(255, 255, 255, 0.95);
        margin-bottom: 8px;
        list-style: disc; /* Th√™m ki·ªÉu list */
      }
      #nextSongs h4 {
        font-size: 14px;
        color: #00ffff;
        font-weight: bold; /* ƒê·∫≠m h∆°n cho ti√™u ƒë·ªÅ */
        margin-bottom: 6px;
        margin-top: 0;
      }

      #playPauseBtn {
        background-color: #00cc99;
        color: white;
      }
      #playPauseBtn:hover {
        background-color: #00aa88;
      }

      button {
        font-size: 16px;
        padding: 6px 10px;
        border: none;
        border-radius: 6px;
        background-color: #333;
        color: white;
        cursor: pointer;
      }

      button:hover {
        background-color: #555;
      }

      #toast {
        position: fixed;
        top: 10px;
        left: 50%;
        transform: translateX(-50%);
        background-color: #333;
        color: white;
        padding: 20px 24px;
        border-radius: 8px;
        font-size: 30px;
        opacity: 0;
        transition: opacity 0.5s ease;
        z-index: 9999;
        visibility: hidden; /* D√πng visibility ƒë·ªÉ ·∫©n h·∫≥n khi opacity = 0 */
      }

      #toast.show {
        visibility: visible;
        opacity: 1;
      }
      
      /* C·∫≠p nh·∫≠t style cho M√£ k·∫øt n·ªëi */
      #roomCodeDisplay {
          font-size:18px;
          color:yellow;
          padding-left:1px;
          margin-bottom: 10px;
      }
      #roomCodeDisplay #code {
          font-weight: bold;
          font-size: 24px;
          color: #f1c40f;
      }
      
    </style>
  </head>
  <body>
    <div id="player"></div>

    <div id="uiContainer">
       <div id="roomCodeDisplay">
          M√£ k·∫øt n·ªëi: <span id="code">...</span>
          <button onclick="resetRoomCode()" style="margin-left: 10px;">üîÑƒê·ªïi m√£</button>
       </div>
      <div id="controls">
        <button id="playPauseBtn" onclick="togglePlayPause()">‚èØ</button>
        <button onclick="nextSong()">‚è≠</button>
        <div id="currentTitle"><div id="scrollingTitle">ƒêang t·∫£i...</div></div>
      </div>

      <div id="nextSongs">
        <h4>üé∂ Ti·∫øp theo:</h4>
        <ul id="playlistDisplay"></ul>
      </div>
    </div>
    <div id="toast"></div>

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://www.youtube.com/iframe_api"></script>

    <script>
      // --- C·∫§U H√åNH FIREBASE ---
      const firebaseConfig = {
        apiKey: "AIzaSyAIwBqg8EYLU7TQXfOO697C4D5p5_GeghQ",
        authDomain: "karaoke-home.firebaseapp.com",
        databaseURL: "https://karaoke-home-default-rtdb.asia-southeast1.firebasedatabase.app",
        projectId: "karaoke-home",
        storageBucket: "karaoke-home.firebasestorage.app",
        messagingSenderId: "285959719922",
        appId: "1:285959719922:web:6cb594ebb3ef854124796b",
        measurementId: "G-EH8DQLGWSY"
      };

      if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
      const db = firebase.database();

      let player;
      let currentVideoId = "";
      let playlist = [];
      let isPlayerReady = false;
      let isPlaying = false; // Theo d√µi tr·∫°ng th√°i c·ªßa tr√¨nh ph√°t
      let roomCode = localStorage.getItem('roomCode');
      const codeDisplayEl = document.getElementById('code');

      if (!roomCode) {
        roomCode = Math.floor(10000 + Math.random() * 90000).toString();
        localStorage.setItem('roomCode', roomCode);
      }
      codeDisplayEl.innerText = roomCode;

      // --- FIX QUAN TR·ªåNG: KI·ªÇM TRA M√îI TR∆Ø·ªúNG ---
      if (window.location.protocol === 'file:') {
          console.error("L·ªñI: B·∫°n ƒëang m·ªü file tr·ª±c ti·∫øp (file://). YouTube API s·∫Ω kh√¥ng ho·∫°t ƒë·ªông.");
      }

      function onYouTubeIframeAPIReady() {
        const WAITING_VIDEO_ID = "ScMzIvxBSi4"; 

        player = new YT.Player('player', {
          height: '100%', 
          width: '100%',
          videoId: WAITING_VIDEO_ID, 
          host: 'https://www.youtube.com',
          playerVars: { 
            'autoplay': 1, 
            'controls': 1, /* ƒê·ªïi th√†nh 1 ƒë·ªÉ cho ph√©p ƒëi·ªÅu khi·ªÉn */
            'modestbranding': 1,
            'rel': 0,                 
            'enablejsapi': 1,         
            'origin': window.location.origin 
          },
          events: {
            'onStateChange': onPlayerStateChange,
            'onReady': (event) => {
                 console.log("Player Ready");
                 isPlayerReady = true;
                 event.target.playVideo(); 
                 isPlaying = true;
                 listenToData(); 
            },
            'onError': onPlayerError 
          }
        });
      }

      function listenToData() {
        // L·∫Øng nghe Playlist
        db.ref(`rooms/${roomCode}/playlist`).orderByChild('timestamp').on('value', snapshot => {
          playlist = [];
          snapshot.forEach(child => {
            playlist.push({ key: child.key, ...child.val() });
          });
          playlist.sort((a, b) => a.timestamp - b.timestamp);

          updateUI();
          checkAndPlay();
        });

        // L·∫Øng nghe Command
        db.ref(`rooms/${roomCode}/command`).on('value', snapshot => {
          const cmdData = snapshot.val();
          if (cmdData) {
            executeCommand(cmdData.type);
            // Xo√° l·ªánh sau khi x·ª≠ l√Ω (Gi·ªØ nguy√™n logic Firebase)
            db.ref(`rooms/${roomCode}/command`).remove();
          }
        });
      }

      function updateUI() {
        const listEl = document.getElementById('playlistDisplay');
        const titleEl = document.getElementById('scrollingTitle');
        listEl.innerHTML = "";
        
        if (playlist.length === 0) {
            titleEl.textContent = "üïí Ch·ªù b√†i h√°t...";
            return;
        }
        
        // C·∫≠p nh·∫≠t t√™n b√†i ƒëang ph√°t
        titleEl.textContent = "üéµ " + playlist[0].title;
        
        // C·∫≠p nh·∫≠t danh s√°ch ti·∫øp theo (B·ªè qua b√†i ƒë·∫ßu ti√™n)
        for (let i = 1; i < Math.min(playlist.length, 6); i++) {
          const li = document.createElement('li');
          li.innerText = playlist[i].title;
          listEl.appendChild(li);
        }
      }

      function checkAndPlay() {
        if (!isPlayerReady) return;
        
        if (playlist.length === 0) {
            // Kh√¥ng l√†m g√¨ n·∫øu h·∫øt b√†i
            return; 
        }
        
        const nextSong = playlist[0];
        if (nextSong.videoId !== currentVideoId) {
          currentVideoId = nextSong.videoId;
          console.log("Loading video:", currentVideoId);
          player.loadVideoById(currentVideoId);
          isPlaying = true; // Gi·∫£ ƒë·ªãnh khi load l√† ph√°t
        }
      }

      function onPlayerStateChange(event) {
        if (event.data === YT.PlayerState.ENDED) {
            if (playlist.length > 0) {
                removeCurrentSong();
            } else {
                player.playVideo(); // Loop b√†i ch·ªù n·∫øu kh√¥ng c√≥ nh·∫°c
            }
        } else if (event.data === YT.PlayerState.PLAYING) {
            isPlaying = true;
        } else if (event.data === YT.PlayerState.PAUSED) {
            isPlaying = false;
        }
      }

      function onPlayerError(event) {
        console.error("YouTube Error Code:", event.data);
        // T·ª± ƒë·ªông qua b√†i sau 2 gi√¢y n·∫øu l·ªói
        setTimeout(() => {
            if(playlist.length > 0) removeCurrentSong();
        }, 2000);
      }

      function removeCurrentSong() {
        if (playlist.length > 0) {
            const keyToRemove = playlist[0].key;
            // Gi·ªØ nguy√™n logic x√≥a b√†i hi·ªán t·∫°i tr√™n Firebase
            db.ref(`rooms/${roomCode}/playlist/${keyToRemove}`).remove();
            currentVideoId = ""; 
        }
      }
      
      // --- CH·ª®C NƒÇNG ƒêI·ªÄU KHI·ªÇN UI ---
      function nextSong() {
          // G·ª≠i l·ªánh NEXT l√™n Firebase (Gi·ªØ nguy√™n logic Firebase, nh∆∞ng d√πng h√†m UI)
          removeCurrentSong();
      }

      function togglePlayPause() {
        if (!player || !isPlayerReady) return;
        const state = player.getPlayerState();
        if (state === YT.PlayerState.PLAYING) {
          player.pauseVideo();
          isPlaying = false;
        } else {
          player.playVideo();
          isPlaying = true;
        }
      }
      
      function resetRoomCode() {
        localStorage.removeItem('roomCode');
        location.reload();
      }

      function executeCommand(cmd) {
        if (!player || !isPlayerReady) return;
        try {
            switch (cmd) {
            case 'PLAY': 
                player.playVideo(); 
                showToast("‚ñ∂Ô∏è Play");
                isPlaying = true;
                break;
            case 'PAUSE': 
                player.pauseVideo(); 
                showToast("‚è∏ Pause");
                isPlaying = false;
                break;
            case 'VOL_UP': 
                player.setVolume(Math.min(player.getVolume() + 10, 100)); 
                showToast("üîä Volume Up");
                break;
            case 'VOL_DOWN': 
                player.setVolume(Math.max(player.getVolume() - 10, 0)); 
                showToast("üîâ Volume Down");
                break;
            case 'NEXT': 
                removeCurrentSong(); 
                showToast("‚è≠ Next Song");
                break;
            }
        } catch (e) { console.error(e); }
      }
      
      function showToast(message) {
        const toast = document.getElementById('toast');
        toast.textContent = message;
        toast.className = 'show';
        setTimeout(() => toast.className = '', 2000);
      }
    </script>
  </body>
</html>
