<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Karaoke Player</title>
  <style>
    body { background: #000; color: white; font-family: Arial; overflow: hidden; margin: 0; }
    #player { position: absolute; top: 0; left: 0; width: 100vw; height: 100vh; z-index: 1; }
    #overlay { position: absolute; top: 20px; right: 20px; z-index: 2; background: rgba(0,0,0,0.6); padding: 20px; border-radius: 10px; text-align: right; }
    h1 { margin: 0; font-size: 40px; color: #f1c40f; }
    #nextList { font-size: 20px; color: #ddd; margin-top: 10px; list-style: none; padding: 0; }
    #nextList li { margin-bottom: 5px; border-bottom: 1px solid #444; padding-bottom: 2px;}
    #marquee { position: fixed; bottom: 0; left: 0; width: 100%; background: rgba(0,0,0,0.8); font-size: 40px; padding: 15px; white-space: nowrap; overflow: hidden; z-index: 3; display: none;}
    #marquee span { display: inline-block; padding-left: 100%; animation: scroll 15s linear infinite; color: #00ffcc;}
    @keyframes scroll { 0% { transform: translate(0, 0); } 100% { transform: translate(-100%, 0); } }
  </style>
  
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
  <script src="https://www.youtube.com/iframe_api"></script>
</head>
<body>

  <div id="player"></div>

  <div id="overlay">
    <div>M√£ k·∫øt n·ªëi:</div>
    <h1 id="roomCode">...</h1>
    <div style="margin-top:15px; font-weight:bold; color: #3498db;">Ti·∫øp theo:</div>
    <ul id="nextList"></ul>
  </div>

  <div id="marquee"><span id="scrollingText"></span></div>

<script>
  // --- C·∫§U H√åNH FIREBASE ---
  const firebaseConfig = {
    apiKey: "AIzaSyAIwBqg8EYLU7TQXfOO697C4D5p5_GeghQ",
    authDomain: "karaoke-home.firebaseapp.com",
    databaseURL: "https://karaoke-home-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "karaoke-home",
    storageBucket: "karaoke-home.firebasestorage.app",
    messagingSenderId: "285959719922",
    appId: "1:285959719922:web:6cb594ebb3ef854124796b",
    measurementId: "G-EH8DQLGWSY"
  };

  if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
  const db = firebase.database();

  let player;
  let currentVideoId = "";
  let playlist = [];
  let isPlayerReady = false;
  let roomCode = localStorage.getItem('roomCode');

  if (!roomCode) {
    roomCode = Math.floor(10000 + Math.random() * 90000).toString();
    localStorage.setItem('roomCode', roomCode);
  }
  document.getElementById('roomCode').innerText = roomCode;

  // --- FIX QUAN TR·ªåNG: KI·ªÇM TRA M√îI TR∆Ø·ªúNG ---
  if (window.location.protocol === 'file:') {
      alert("L·ªñI: B·∫°n ƒëang m·ªü file tr·ª±c ti·∫øp (file://). YouTube API s·∫Ω kh√¥ng ho·∫°t ƒë·ªông. H√£y d√πng Live Server ho·∫∑c up l√™n Github Pages.");
  }

  function onYouTubeIframeAPIReady() {
    // ID video m√†n h√¨nh ƒëen (ch·ªù), d√πng ƒë·ªÉ kh·ªüi t·∫°o player kh√¥ng b·ªã l·ªói
    const WAITING_VIDEO_ID = "ScMzIvxBSi4"; 

    player = new YT.Player('player', {
      height: '100%', 
      width: '100%',
      videoId: WAITING_VIDEO_ID, // FIX: Ph·∫£i c√≥ video ID ban ƒë·∫ßu
      host: 'https://www.youtube.com',
      playerVars: { 
        'autoplay': 1, 
        'controls': 0, 
        'modestbranding': 1,
        'rel': 0,                 
        'enablejsapi': 1,         
        'origin': window.location.origin 
      },
      events: {
        'onStateChange': onPlayerStateChange,
        'onReady': (event) => {
             console.log("Player Ready");
             isPlayerReady = true;
             event.target.playVideo(); 
             listenToData(); // B·∫Øt ƒë·∫ßu k·∫øt n·ªëi Firebase
        },
        'onError': onPlayerError 
      }
    });
  }

  function listenToData() {
    db.ref(`rooms/${roomCode}/playlist`).orderByChild('timestamp').on('value', snapshot => {
      playlist = [];
      snapshot.forEach(child => {
        playlist.push({ key: child.key, ...child.val() });
      });
      playlist.sort((a, b) => a.timestamp - b.timestamp);

      updateUI();
      checkAndPlay();
    });

    db.ref(`rooms/${roomCode}/command`).on('value', snapshot => {
      const cmdData = snapshot.val();
      if (cmdData) {
        executeCommand(cmdData.type);
        db.ref(`rooms/${roomCode}/command`).remove();
      }
    });
  }

  function updateUI() {
    const listEl = document.getElementById('nextList');
    listEl.innerHTML = "";
    // B·ªè qua b√†i ƒë·∫ßu ti√™n (ƒëang ph√°t)
    for (let i = 1; i < Math.min(playlist.length, 6); i++) {
      const li = document.createElement('li');
      li.innerText = playlist[i].title;
      listEl.appendChild(li);
    }

    const marquee = document.getElementById('marquee');
    const scrollText = document.getElementById('scrollingText');
    if (playlist.length > 0) {
      marquee.style.display = 'block';
      scrollText.innerText = "üéµ ƒêang ph√°t: " + playlist[0].title;
    } else {
      marquee.style.display = 'none';
    }
  }

  function checkAndPlay() {
    if (!isPlayerReady) return;
    
    if (playlist.length === 0) {
        // H·∫øt b√†i th√¨ kh√¥ng l√†m g√¨, gi·ªØ nguy√™n m√†n h√¨nh ch·ªù ho·∫∑c ƒëen
        return; 
    }
    
    const nextSong = playlist[0];
    if (nextSong.videoId !== currentVideoId) {
      currentVideoId = nextSong.videoId;
      console.log("Loading video:", currentVideoId);
      player.loadVideoById(currentVideoId);
    }
  }

  function onPlayerStateChange(event) {
    if (event.data === YT.PlayerState.ENDED) {
        // Ch·ªâ xo√° n·∫øu ƒë√≥ l√† b√†i h√°t th·∫≠t, kh√¥ng xo√° b√†i ch·ªù
        if (playlist.length > 0) {
            removeCurrentSong();
        } else {
            player.playVideo(); // Loop b√†i ch·ªù n·∫øu kh√¥ng c√≥ nh·∫°c
        }
    }
  }

  function onPlayerError(event) {
    console.error("YouTube Error Code:", event.data);
    // T·ª± ƒë·ªông qua b√†i sau 2 gi√¢y n·∫øu l·ªói
    setTimeout(() => {
        if(playlist.length > 0) removeCurrentSong();
    }, 2000);
  }

  function removeCurrentSong() {
    if (playlist.length > 0) {
        const keyToRemove = playlist[0].key;
        db.ref(`rooms/${roomCode}/playlist/${keyToRemove}`).remove();
        currentVideoId = ""; 
    }
  }

  function executeCommand(cmd) {
    if (!player || !isPlayerReady) return;
    try {
        switch (cmd) {
        case 'PLAY': player.playVideo(); break;
        case 'PAUSE': player.pauseVideo(); break;
        case 'VOL_UP': player.setVolume(Math.min(player.getVolume() + 10, 100)); break;
        case 'VOL_DOWN': player.setVolume(Math.max(player.getVolume() - 10, 0)); break;
        case 'NEXT': removeCurrentSong(); break;
        }
    } catch (e) { console.error(e); }
  }
</script>
</body>
</html>
